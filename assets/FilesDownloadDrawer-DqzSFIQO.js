import{b as c,j as x}from"./@uiw/react-codemirror-dimZJgSu.js";import{a as B}from"./FilesDrawer-DH-ydRHZ.js";import{i as C}from"./index-B3cNn7YV.js";import{b as L,Q as U}from"./index-CwDalt6B.js";function S({targetType:g="list",title:H="ä¸‹è½½æ–‡ä»¶/æ–‡ä»¶å¤¹",open:u=!1,setOpen:d,list:F=[],onSuccess:E,isSelectFolder:i=!0}){const{t:w}=L(),{message:b}=U.useApp(),[R,f]=c.useState(u),[y,D]=c.useState(i);c.useEffect(()=>{D(i)},[i]);const l=c.useRef(null);c.useEffect(()=>(u?i?(async()=>{if(!window.showDirectoryPicker){b.warning(w("components.FilesDownloadDrawer.noSupport",{defaultValue:"å½“å‰æµè§ˆå™¨ä¸æ”¯æŒé€‰æ‹©æ–‡ä»¶å¤¹ï¼Œå°†ä½¿ç”¨æ™®é€šä¸‹è½½"})),D(!1),f(!0);return}try{const o=await window.showDirectoryPicker({mode:"readwrite",id:"FilesDownloadDrawer"});if(!o)return;l.current=o,f(!0)}catch(o){d(!1),o instanceof Error&&o.message.includes("aborted")?b.warning(w("components.FilesDownloadDrawer.chooseFolder",{defaultValue:"è¯·é€‰æ‹©æ–‡ä»¶å¤¹"})):console.log("ðŸš€ ~ selectDirectoryStoreFn ~ error:",o)}})():f(!0):f(!1),()=>{l.current=null}),[u,i,w,b,d]);const k=c.useCallback(async n=>{const o=async e=>{try{const r=await fetch(e);if(!r.ok)throw new Error(`error: ${r.status} ${r.statusText}`);return await r.blob()}catch(r){throw new Error(`download error: ${r}`)}},P=async e=>{if(l.current)try{if(e.type==="folder"){const a=e.filePath.split("/").filter(s=>s!=="");let t=l.current;for(const s of a)t=await t.getDirectoryHandle(s,{create:!0});return}let r;if(e.url instanceof Blob?r=e.url:r=await o(e.url),e.folderPath==="/"){const t=await(await l.current.getFileHandle(e.name,{create:!0})).createWritable();await t.write(r),await t.close()}else{const a=e.folderPath.split("/").filter(p=>p!=="");let t=l.current;for(const p of a)t=await t.getDirectoryHandle(p,{create:!0});const h=await(await t.getFileHandle(e.name,{create:!0})).createWritable();await h.write(r),await h.close()}}catch(r){throw new Error(`error: ${r}`)}},j=async e=>{if(e.type==="folder")return;console.log("downloadFile",e);const r=e.url instanceof Blob?!1:C(e.url);let a="";if(e.url instanceof Blob)a=URL.createObjectURL(e.url);else if(r){const s=await o(e.url);a=URL.createObjectURL(s)}else a=e.url;const t=document.createElement("a");t.href=a,t.target="_blank",t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t),(e.url instanceof Blob||r)&&URL.revokeObjectURL(a)};(n.type==="file"&&n.url||n.type==="folder")&&(y?await P(n):await j(n))},[y]);return x.jsx(B,{targetType:g,title:H,open:R,setOpen:d,list:F,doneFile:k,onSuccess:E})}export{S as F};

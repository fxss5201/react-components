import React from 'react'
import Playground from '@/components/Playground'
import FilesListUpload from './FilesListUpload'
import FilesListUploadRaw from './FilesListUpload.tsx?raw'
import FilesListUploadTree from './FilesListUploadTree'
import FilesListUploadTreeRaw from './FilesListUploadTree.tsx?raw'
import FilesDrawerImg from '@/assets/FilesDrawer.png'
import FilesDownload from './FilesDownload'
import FilesDownloadRaw from './FilesDownload.tsx?raw'

# FilesDrawer

`FilesDrawer` ç»„ä»¶æ˜¯è§†å›¾æŠ½è±¡å±‚ï¼Œæä¾›æ ·å¼å’Œå†…éƒ¨é€»è¾‘ï¼Œå¯ä»¥ç”¨äºæ–‡ä»¶/æ–‡ä»¶å¤¹çš„ä¸Šä¼ ã€ä¸‹è½½ã€å‹ç¼©ç­‰ï¼Œæ ·å¼å¦‚ä¸‹ï¼š

<img src={FilesDrawerImg} alt='FilesDrawer' />

**æ³¨æ„ï¼šå½“çˆ¶æ–‡ä»¶å¤¹å¤±è´¥çš„æ—¶å€™ï¼Œå†…éƒ¨çš„å­æ–‡ä»¶/æ–‡ä»¶å¤¹ç›´æ¥å¤±è´¥ã€‚**

## ç›®å½•

## API

### å‚æ•° Props

``` ts
export type DrawerFileItemType = FileItemType & {
  icon?: React.ReactNode,
  percent?: number,
  percentStatus?: ProgressProps['status'],
}

export type DrawerResultFileTreeItemType = DrawerFileItemType & {
  children?: DrawerResultFileTreeItemType[]
}

export type FilesDrawerProps = {
  targetType?: TargetType,
  title?: string,
  open: boolean,
  setOpen: (open: boolean) => void,
  list: FileItemType[],
  doneFile: (fileItem: DrawerFileItemType) => Promise<void>,
  onSuccess?: (fileTrees: DrawerResultFileTreeItemType[]) => void,
}
```

| å±æ€§ | è¯´æ˜ | ç±»å‹ | é»˜è®¤å€¼ |
| --- | --- | --- | --- |
| `targetType` | æˆåŠŸå›è°ƒå‡½æ•°çš„å‚æ•°ç±»å‹ | `tree \| list` | `list` |
| `title` | æŠ½å±‰æ ‡é¢˜ | `string` | - |
| `open` | æ˜¯å¦æ‰“å¼€æŠ½å±‰ | `boolean` | `false` |
| `setOpen` | æ‰“å¼€/å…³é—­æŠ½å±‰çš„å›è°ƒå‡½æ•° | `(open: boolean) => void` | - |
| `list` | æ–‡ä»¶/æ–‡ä»¶å¤¹åˆ—è¡¨ | `FileItemType[]` | [] |
| `doneFile` | å¤„ç†æ–‡ä»¶/æ–‡ä»¶å¤¹çš„å›è°ƒå‡½æ•° | `(fileItem: DrawerFileItemType) => Promise<void>` | - |
| `onSuccess` | ä¸Šä¼ æˆåŠŸå›è°ƒå‡½æ•° | `(fileTrees: DrawerResultFileTreeItemType[]) => void` | - |

## å…·ä½“å®ç°

### FilesUploadDrawer

`FilesUploadDrawer` ç»„ä»¶æ˜¯ `FilesDrawer` ç»„ä»¶çš„å…·ä½“å®ç°ï¼Œåœ¨å†…éƒ¨å®ç°äº†æ–‡ä»¶/æ–‡ä»¶å¤¹çš„ä¸Šä¼ é€»è¾‘ã€‚

#### å‚æ•° Props

``` ts
export type FilesUploadDrawerProps = Omit<FilesDrawerProps, 'title' | 'doneFile'> & {
  title?: string,
}
```

| å±æ€§ | è¯´æ˜ | ç±»å‹ | é»˜è®¤å€¼ |
| --- | --- | --- | --- |
| `targetType` | æˆåŠŸå›è°ƒå‡½æ•°çš„å‚æ•°ç±»å‹ | `tree \| list` | `list` |
| `title` | æŠ½å±‰æ ‡é¢˜ | `string` | - |
| `open` | æ˜¯å¦æ‰“å¼€æŠ½å±‰ | `boolean` | `false` |
| `setOpen` | æ‰“å¼€/å…³é—­æŠ½å±‰çš„å›è°ƒå‡½æ•° | `(open: boolean) => void` | - |
| `list` | æ–‡ä»¶/æ–‡ä»¶å¤¹åˆ—è¡¨ | `FileItemType[]` | [] |
| `onSuccess` | ä¸Šä¼ æˆåŠŸå›è°ƒå‡½æ•° | `(fileTrees: DrawerResultFileTreeItemType[]) => void` | - |

#### æºä»£ç 

``` tsx
import FilesDrawer, { type FilesDrawerProps, type DrawerFileItemType } from '@/components/FilesDrawer'
import fileUploadMock from '@/common/fileUploadMock'
import { useCallback } from 'react'

export type FilesUploadDrawerProps = Omit<FilesDrawerProps, 'title' | 'doneFile'> & {
  title?: string,
}

function FilesUploadDrawer({
  targetType = 'list',
  title = 'ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹',
  open = false,
  setOpen,
  list = [],
  onSuccess
}: FilesUploadDrawerProps) {
  const doneFile = useCallback(async (item: DrawerFileItemType) => {
    if (item.type === 'file') {
      await fileUploadMock()
    } else {
      await fileUploadMock()
    }
  }, [])

  return (
    <FilesDrawer
      targetType={targetType}
      title={title}
      open={open}
      setOpen={setOpen}
      list={list}
      doneFile={doneFile}
      onSuccess={onSuccess}
    />
  )
}

export default FilesUploadDrawer
```

#### ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹

<Playground code={FilesListUploadRaw} title='ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹' description='é€‰æ‹©ä¹‹åç›´æ¥ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼Œä¸Šä¼ æˆåŠŸä¹‹åè¿”å›æ–‡ä»¶/æ–‡ä»¶å¤¹çš„åˆ—è¡¨ç»“æ„ã€‚'>
  <FilesListUpload />
</Playground>

#### ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæ ‘ç»“æ„ï¼‰

<Playground code={FilesListUploadTreeRaw} title='ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæ ‘ç»“æ„ï¼‰' description='é€‰æ‹©ä¹‹åç›´æ¥ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼Œä¸Šä¼ æˆåŠŸä¹‹åè¿”å›æ–‡ä»¶/æ–‡ä»¶å¤¹çš„æ ‘ç»“æ„ã€‚'>
  <FilesListUploadTree />
</Playground>

### FilesDownloadDrawer

#### å‚æ•° Props

``` ts
export type FileDownloadItemType = Omit<FileItemType, 'file' | 'url'> & {
  url: string
}

export type FilesDownloadDrawerProps = Omit<FilesDrawerProps, 'title' | 'doneFile' | 'list'> & {
  title?: string
  list: FileDownloadItemType[]
  isSelectFolder?: boolean
}
```

| å±æ€§ | è¯´æ˜ | ç±»å‹ | é»˜è®¤å€¼ |
| --- | --- | --- | --- |
| `targetType` | æˆåŠŸå›è°ƒå‡½æ•°çš„å‚æ•°ç±»å‹ | `tree \| list` | `list` |
| `title` | æŠ½å±‰æ ‡é¢˜ | `string` | - |
| `open` | æ˜¯å¦æ‰“å¼€æŠ½å±‰ | `boolean` | `false` |
| `setOpen` | æ‰“å¼€/å…³é—­æŠ½å±‰çš„å›è°ƒå‡½æ•° | `(open: boolean) => void` | - |
| `list` | æ–‡ä»¶/æ–‡ä»¶å¤¹åˆ—è¡¨ | `FileDownloadItemType[]` | [] |
| `onSuccess` | ä¸Šä¼ æˆåŠŸå›è°ƒå‡½æ•° | `(fileTrees: DrawerResultFileTreeItemType[]) => void` | - |
| `isSelectFolder` | æ˜¯å¦é€‰æ‹©æ–‡ä»¶å¤¹è¿›è¡Œä¸‹è½½ï¼Œå¦‚æœè®¾ç½®ä¸º `false`ï¼Œåˆ™ä¼šä½¿ç”¨æ™®é€šä¸‹è½½ï¼Œè®¾ç½®ä¸º `true` æ—¶ï¼Œä¼šæç¤ºç”¨æˆ·é€‰æ‹©æ–‡ä»¶å¤¹ï¼Œå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ï¼Œä¹Ÿä¼šä½¿ç”¨æ™®é€šä¸‹è½½ | `boolean` | `true` |

**æ³¨æ„ï¼šä¸‹è½½çš„æ—¶å€™ï¼Œæ¯ä¸ªæ–‡ä»¶å¿…é¡»æœ‰å¯¹åº”çš„ `url` å±æ€§ï¼Œå¦åˆ™ä¼šè·³è¿‡ã€‚ä¼šæ ¹æ®æ–‡ä»¶/æ–‡ä»¶å¤¹çš„è·¯å¾„ï¼Œåœ¨ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºå¯¹åº”çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ã€‚**

#### æºä»£ç 

``` tsx
import FilesDrawer, { type FilesDrawerProps, type DrawerFileItemType } from '@/components/FilesDrawer'
import type { FileDownloadItemType } from '@/types/files'
import { useCallback, useEffect, useRef, useState } from 'react'
import { useTranslation } from 'react-i18next'
import { App } from 'antd'
import { isCrossOrigin } from '@/utils'

export type FilesDownloadDrawerProps = Omit<FilesDrawerProps, 'title' | 'doneFile' | 'list'> & {
  title?: string
  list: FileDownloadItemType[]
  isSelectFolder?: boolean
}

function FilesDownloadDrawer({
  targetType = 'list',
  title = 'ä¸‹è½½æ–‡ä»¶/æ–‡ä»¶å¤¹',
  open = false,
  setOpen,
  list = [],
  onSuccess,
  isSelectFolder = true
}: FilesDownloadDrawerProps) {
  const { t } = useTranslation()
  const { message } = App.useApp()
  const [drawerOpen, setDrawerOpen] = useState(open)
  const [canSelectFolder, setCanSelectFolder] = useState(isSelectFolder)
  useEffect(() => {
    setCanSelectFolder(isSelectFolder)
  }, [isSelectFolder])

  const directoryHandle = useRef<FileSystemDirectoryHandle>(null)
  useEffect(() => {
    const getDirectoryHandle = async () => {
      if (!window.showDirectoryPicker) {
        message.warning(t('components.FilesDownloadDrawer.noSupport', { defaultValue: 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒé€‰æ‹©æ–‡ä»¶å¤¹ï¼Œå°†ä½¿ç”¨æ™®é€šä¸‹è½½' }))
        setCanSelectFolder(false)
        setDrawerOpen(true)
        return
      }
      try {
        const dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite',
          id: 'FilesDownloadDrawer',
        })
        if (!dirHandle) {
          return
        }
        directoryHandle.current = dirHandle
        setDrawerOpen(true)
      } catch (error) {
        setOpen(false)
        if (error instanceof Error && error.message.includes('aborted')) {
          message.warning(t('components.FilesDownloadDrawer.chooseFolder', { defaultValue: 'è¯·é€‰æ‹©æ–‡ä»¶å¤¹' }))
        } else {
          console.log("ğŸš€ ~ selectDirectoryStoreFn ~ error:", error)
        }
      }
    }

    if (open) {
      if (isSelectFolder) {
        getDirectoryHandle()
      } else {
        setDrawerOpen(true)
      }
    } else {
      setDrawerOpen(false)
    }
    return () => {
      directoryHandle.current = null
    }
  }, [open, isSelectFolder, t, message, setOpen])

  const doneFile = useCallback(async (item: DrawerFileItemType) => {
    const downloadResourceAsBlob = async (url: string) => {
      try {
        const response = await fetch(url)
        if (!response.ok) {
          throw new Error(`error: ${response.status} ${response.statusText}`)
        }
        return await response.blob()
      } catch (error) {
        throw new Error(`download error: ${error}`)
      }
    }

    const writeFile = async (item: DrawerFileItemType) => {
      if (!directoryHandle.current) {
        return
      }
      if (item.folderPath === '/') {
        const fileHandle = await directoryHandle.current.getFileHandle(item.name, { create: true })
        const writable = await fileHandle.createWritable()
        await writable.write(await downloadResourceAsBlob(item.url!))
        await writable.close()
      } else {
        const folderPath = item.folderPath.split('/').filter(x => x !== '')
        let currentDirHandle = directoryHandle.current
        for (const folder of folderPath) {
          currentDirHandle = await currentDirHandle.getDirectoryHandle(folder, { create: true })
        }
        const fileHandle = await currentDirHandle.getFileHandle(item.name, { create: true })
        const writable = await fileHandle.createWritable()
        await writable.write(await downloadResourceAsBlob(item.url!))
        await writable.close()
      }
    }

    const downloadFile = async (item: DrawerFileItemType) => {
      console.log('downloadFile', item)
      const isCross = isCrossOrigin(item.url!)
      let url = item.url!
      if (isCross) {
        const blob = await downloadResourceAsBlob(item.url!)
        url = URL.createObjectURL(blob)
      }
      const a = document.createElement('a')
      a.href = url
      a.target = '_blank'
      a.download = item.name
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      if (isCross) URL.revokeObjectURL(url)
    }
    if (item.url) {
      if (canSelectFolder) {
        await writeFile(item)
      } else {
        await downloadFile(item)
      }
    }
  }, [canSelectFolder])

  return (
    <FilesDrawer
      targetType={targetType}
      title={title}
      open={drawerOpen}
      setOpen={setOpen}
      list={list}
      doneFile={doneFile}
      onSuccess={onSuccess}
    />
  )
}

export default FilesDownloadDrawer
```

#### ä¸‹è½½æ–‡ä»¶/æ–‡ä»¶å¤¹

<Playground code={FilesDownloadRaw} title='ä¸‹è½½æ–‡ä»¶/æ–‡ä»¶å¤¹' description='é€‰æ‹©æ–‡ä»¶å¤¹ä¸‹è½½æˆ–è€…æ™®é€šä¸‹è½½ï¼ŒæŸ¥çœ‹ä¸‹è½½æ•ˆæœã€‚'>
  <FilesDownload />
</Playground>

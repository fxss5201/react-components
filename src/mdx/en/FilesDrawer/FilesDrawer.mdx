import React from 'react'
import Playground from '@/components/Playground'
import FilesListUpload from './FilesListUpload'
import FilesListUploadRaw from './FilesListUpload.tsx?raw'
import FilesListUploadTree from './FilesListUploadTree'
import FilesListUploadTreeRaw from './FilesListUploadTree.tsx?raw'
import FilesDrawerImg from '@/assets/FilesDrawer.png'
import FilesDownload from './FilesDownload'
import FilesDownloadRaw from './FilesDownload.tsx?raw'

# FilesDrawer

`FilesDrawer` is a view abstract layer that provides styles and internal logic for uploading, downloading, compressing, etc. of files/folders. The style is as follows:

<img src={FilesDrawerImg} alt='FilesDrawer' />

**Note: When the parent folder fails to upload, the internal child files/folders fail to upload directly.**
## TOC

## API

### Parameters Props

``` ts
export type DrawerFileItemType = FileItemType & {
  icon?: React.ReactNode,
  percent?: number,
  percentStatus?: ProgressProps['status'],
}

export type DrawerResultFileTreeItemType = DrawerFileItemType & {
  children?: DrawerResultFileTreeItemType[]
}

export type FilesDrawerProps = {
  targetType?: TargetType,
  title?: string,
  open: boolean,
  setOpen: (open: boolean) => void,
  list: FileItemType[],
  doneFile: (fileItem: DrawerFileItemType) => Promise<void>,
  onSuccess?: (fileTrees: DrawerResultFileTreeItemType[]) => void,
}
```

| Parameter | Description | Type | Default |
| --- | --- | --- | --- |
| `targetType` | The parameter type of the callback function for successful upload | `tree \| list` | `list` |
| `title` | Drawer title | `string` | - |
| `open` | Whether the drawer is open | `boolean` | `false` |
| `setOpen` | Callback function to open/close the drawer | `(open: boolean) => void` | - |
| `list` | List of files/folders to upload | `FileItemType[]` | [] |
| `doneFile` | Callback function to handle files/folders | `(fileItem: DrawerFileItemType) => Promise<void>` | - |
| `onSuccess` | Callback function when upload succeeds | `(fileTrees: DrawerResultFileTreeItemType[]) => void` | - |

## Usage

### FilesUploadDrawer

`FilesUploadDrawer` is a concrete implementation of the `FilesDrawer` component, which internally implements the logic of uploading files/folders.

#### Parameters Props

``` ts
export type FilesUploadDrawerProps = Omit<FilesDrawerProps, 'title' | 'doneFile'> & {
  title?: string,
}
```

| Parameter | Description | Type | Default |
| --- | --- | --- | --- |
| `targetType` | The parameter type of the callback function for successful upload | `tree \| list` | `list` |
| `title` | Drawer title | `string` | - |
| `open` | Whether the drawer is open | `boolean` | `false` |
| `setOpen` | Callback function to open/close the drawer | `(open: boolean) => void` | - |
| `list` | List of files/folders to upload | `FileItemType[]` | [] |
| `onSuccess` | Callback function when upload succeeds | `(fileTrees: DrawerResultFileTreeItemType[]) => void` | - |

#### Source Code

``` tsx
import FilesDrawer, { type FilesDrawerProps, type DrawerFileItemType } from '@/components/FilesDrawer'
import fileUploadMock from '@/common/fileUploadMock'

export type FilesUploadDrawerProps = Omit<FilesDrawerProps, 'doneFile'>

function FilesUploadDrawer({
  targetType = 'list',
  title = 'ä¸Šä¼ æ–‡ä»¶/æ–‡ä»¶å¤¹',
  open = false,
  setOpen,
  list = [],
  onSuccess
}: FilesUploadDrawerProps) {
  const doneFile = async (item: DrawerFileItemType) => {
    if (item.type === 'file') {
      await fileUploadMock()
    } else {
      await fileUploadMock()
    }
  }

  return (
    <FilesDrawer
      targetType={targetType}
      title={title}
      open={open}
      setOpen={setOpen}
      list={list}
      doneFile={doneFile}
      onSuccess={onSuccess}
    />
  )
}

export default FilesUploadDrawer
```

#### Upload Files/Folders

<Playground code={FilesListUploadRaw} title='Upload Files/Folders' description='After selection, directly upload the file/folder. After successful upload, return the list structure of the file/folder.'>
  <FilesListUpload />
</Playground>

#### Upload Files/Folders Tree

<Playground code={FilesListUploadTreeRaw} title='Upload Files/Folders Tree' description='After selection, directly upload the file/folder. After successful upload, return the tree structure of the file/folder.'>
  <FilesListUploadTree />
</Playground>

### FilesDownloadDrawer

#### Parameters Props

``` ts
export type FilesDownloadDrawerProps = Omit<FilesDrawerProps, 'title' | 'doneFile'> & {
  title?: string
}
```

| Parameter | Description | Type | Default |
| --- | --- | --- | --- |
| `targetType` | The parameter type of the callback function for successful upload | `tree \| list` | `list` |
| `title` | Drawer title | `string` | - |
| `open` | Whether the drawer is open | `boolean` | `false` |
| `setOpen` | Callback function to open/close the drawer | `(open: boolean) => void` | - |
| `list` | List of files/folders to upload | `FileItemType[]` | [] |
| `onSuccess` | Callback function when upload succeeds | `(fileTrees: DrawerResultFileTreeItemType[]) => void` | - |

**Note: When downloading, each file must have a corresponding `url` property, otherwise it will be skipped. The file/folder will be created in the user-selected folder based on its path.**

#### Source Code

``` tsx
import FilesDrawer, { type FilesDrawerProps, type DrawerFileItemType } from '@/components/FilesDrawer'
import { useEffect, useRef, useState } from 'react'
import { useTranslation } from 'react-i18next'
import { App } from 'antd'

export type FilesDownloadDrawerProps = Omit<FilesDrawerProps, 'title' | 'doneFile'> & {
  title?: string
}

function FilesDownloadDrawer({
  targetType = 'list',
  title = 'ä¸‹è½½æ–‡ä»¶/æ–‡ä»¶å¤¹',
  open = false,
  setOpen,
  list = [],
  onSuccess
}: FilesDownloadDrawerProps) {
  const { t } = useTranslation()
  const { message } = App.useApp()
  const [drawerOpen, setDrawerOpen] = useState(open)

  const directoryHandle = useRef<FileSystemDirectoryHandle>(null)
  useEffect(() => {
    const getDirectoryHandle = async () => {
      if (!window.showDirectoryPicker) {
        message.warning(t('components.FilesDownloadDrawer.noSupport', { defaultValue: 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ' }))
        return
      }
      try {
        const dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite',
          id: 'FilesDownloadDrawer',
        })
        if (!dirHandle) {
          return
        }
        directoryHandle.current = dirHandle
        setDrawerOpen(true)
      } catch (error) {
        if (error instanceof Error && error.message.includes('aborted')) {
          message.warning(t('components.FilesDownloadDrawer.chooseFolder', { defaultValue: 'è¯·é€‰æ‹©æ–‡ä»¶å¤¹' }))
        } else {
          console.log("ðŸš€ ~ selectDirectoryStoreFn ~ error:", error)
        }
      }
    }

    if (open) {
      getDirectoryHandle()
    } else {
      setDrawerOpen(false)
    }
    return () => {
      directoryHandle.current = null
    }
  }, [open, t, message])

  const downloadResourceAsBlob = async (url: string) => {
      try {
        const response = await fetch(url)
        if (!response.ok) {
          throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š${response.status} ${response.statusText}`)
        }
        return await response.blob()
      } catch (error) {
        throw new Error(`ä¸‹è½½èµ„æºå¤±è´¥ï¼š${error}`)
      }
    }

  const writeFile = async (item: DrawerFileItemType) => {
    if (!directoryHandle.current) {
      return
    }
    if (item.folderPath === '/') {
      const fileHandle = await directoryHandle.current.getFileHandle(item.name, { create: true })
      const writable = await fileHandle.createWritable()
      await writable.write(await downloadResourceAsBlob(item.url!))
      await writable.close()
    } else {
      const folderPath = item.folderPath.split('/').filter(x => x !== '')
      let currentDirHandle = directoryHandle.current
      for (const folder of folderPath) {
        currentDirHandle = await currentDirHandle.getDirectoryHandle(folder, { create: true })
      }
      const fileHandle = await currentDirHandle.getFileHandle(item.name, { create: true })
      const writable = await fileHandle.createWritable()
      await writable.write(await downloadResourceAsBlob(item.url!))
      await writable.close()
    }
  }

  const doneFile = async (item: DrawerFileItemType) => {
    if (item.url) {
      await writeFile(item)
    }
  }

  return (
    <FilesDrawer
      targetType={targetType}
      title={title}
      open={drawerOpen}
      setOpen={setOpen}
      list={list}
      doneFile={doneFile}
      onSuccess={onSuccess}
    />
  )
}

export default FilesDownloadDrawer
```

#### Download Files/Folders

<Playground code={FilesDownloadRaw} title='Download Files/Folders' description='Directly download files/folders, and after successful download, return the list structure of files/folders.'>
  <FilesDownload />
</Playground>
